<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Deploying Teamspeak on a Raspberry PI kubernetes cluster | Personal blog</title>
<meta name="keywords" content="kubernetes, arm, raspberry">
<meta name="description" content="While this post will end up with a running Teamspeak server, it is very hard on the resources of the Raspberry Pi and might not be suitable for everyday use.
To deploy a teamspeak server on raspberry pi a few things need to be done:
(optional) Get a Kubernetes cluster up and running (this is not required, if you just want to run the docker container directly). Get Teamspeak to run on ARM.">
<meta name="author" content="Florian Bergmann">
<link rel="canonical" href="https://blog.niflheim.cc/posts/teamspeak-k8s-arm/">
<link crossorigin="anonymous" href="https://blog.niflheim.cc/assets/css/stylesheet.41d57c6d60ed753d1e30f2550c0e83c95e5df376fe471d353917de2dd6c9d7bd.css" integrity="sha256-QdV8bWDtdT0eMPJVDA6DyV5d83b&#43;Rx01ORfeLdbJ170=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.niflheim.cc/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.niflheim.cc/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.niflheim.cc/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.niflheim.cc/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.niflheim.cc/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Deploying Teamspeak on a Raspberry PI kubernetes cluster" />
<meta property="og:description" content="While this post will end up with a running Teamspeak server, it is very hard on the resources of the Raspberry Pi and might not be suitable for everyday use.
To deploy a teamspeak server on raspberry pi a few things need to be done:
(optional) Get a Kubernetes cluster up and running (this is not required, if you just want to run the docker container directly). Get Teamspeak to run on ARM." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.niflheim.cc/posts/teamspeak-k8s-arm/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-08T22:59:00+02:00" />
<meta property="article:modified_time" content="2020-05-08T22:59:00+02:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Deploying Teamspeak on a Raspberry PI kubernetes cluster"/>
<meta name="twitter:description" content="While this post will end up with a running Teamspeak server, it is very hard on the resources of the Raspberry Pi and might not be suitable for everyday use.
To deploy a teamspeak server on raspberry pi a few things need to be done:
(optional) Get a Kubernetes cluster up and running (this is not required, if you just want to run the docker container directly). Get Teamspeak to run on ARM."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://blog.niflheim.cc/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Deploying Teamspeak on a Raspberry PI kubernetes cluster",
      "item": "https://blog.niflheim.cc/posts/teamspeak-k8s-arm/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Deploying Teamspeak on a Raspberry PI kubernetes cluster",
  "name": "Deploying Teamspeak on a Raspberry PI kubernetes cluster",
  "description": "While this post will end up with a running Teamspeak server, it is very hard on the resources of the Raspberry Pi and might not be suitable for everyday use.\nTo deploy a teamspeak server on raspberry pi a few things need to be done:\n(optional) Get a Kubernetes cluster up and running (this is not required, if you just want to run the docker container directly). Get Teamspeak to run on ARM.",
  "keywords": [
    "kubernetes", "arm", "raspberry"
  ],
  "articleBody": "While this post will end up with a running Teamspeak server, it is very hard on the resources of the Raspberry Pi and might not be suitable for everyday use.\nTo deploy a teamspeak server on raspberry pi a few things need to be done:\n(optional) Get a Kubernetes cluster up and running (this is not required, if you just want to run the docker container directly). Get Teamspeak to run on ARM. Setup an ingress controller to make the Teamspeak server accessible from the outside world (in this case this will be the Nginx Ingress). Setting up a kubernetes cluster To setup a kubernetes cluster on Raspberry Pis K3S is very good approach, as the cluster will be more lightweight that simply installing upstream kubernetes.\nAs a base I recommend using HypriotOS or Ubuntu Server1 as those allow configuring the images using Cloud-Init.\nMake sure to follow the instructions to use the the legacy backend for iptables if installing kubernetes v1.17 or lower: kubeadm instructions.\nWhen installing k3s to run Teamspeak Traefik should not be installed, as only the 2.x version supports UDP ingresses - so instead nginx-ingress will be installed later:\n1curl -sfL https://get.k3s.io | sh -s - --no-deploy=traefik Deploy Teamspeak Build an ARM image for Teamspeak Teamspeak does not provide a binary for ARM.\nIt is however possible to run it using Qemu - I have already prepared an ARM image that will run the Teamspeak server through qemu that you can find on my Dockerhub - or if you want to see the source checkout the repository on Github.\nThe image is using the same entrypoint.sh as the official image - so if you are already using that one you should be able to use it exactly the same way (if not - feel free to open an issue).\nDeploy the image Now - if you do not want to use kubernetes, you can simply use the image using docker and expose the required Teamspeak ports as you would with docker:\n1docker run -p 9987:9987/udp -p 10011:10011 -p 30033:30033 -e TS3SERVER_LICENSE=accept monadt/teamspeak3-server This way is a lot easier on the resources and will likely run more reliable on a Raspberry PI with \u003c 2 GB of RAM.\nSetup nginx-ingress Get nginx-ingress to run on ARM Setting up the nginx-ingress on a cluster running on ARM needs a few extra steps when using the official documentation.\nThe images used in the manifests are not compatible with armv7 (that is used when running a cluster on a bunch of Raspberry Pis).\nFirst the mandatory.yaml has to be updated to use the images for the arm architecture2:\n1wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml 2sed -i 's/nginx-ingress-controller:0/nginx-ingress-controller-arm:0/' mandatory.yaml The resulting mandatory.yaml file can now be applied to the cluster:\n1kubectl apply -f mandatory.yaml In my local cluster I am using the NodePort approach, so the service for that can be applied next:\n1kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml Setup a Teamspeak deployment With all pieces in place the Teamspeak container can now be deployed onto the cluster:\nSave the following yaml into a file (e.g. teamspeak.yaml).\n1--- 2apiVersion: v1 3kind: Namespace 4metadata: 5 name: teamspeak 6--- 7apiVersion: v1 8kind: PersistentVolumeClaim 9metadata: 10 name: teamspeak-pvc 11 namespace: teamspeak 12spec: 13 accessModes: 14 - ReadWriteOnce 15 storageClassName: local-path 16 resources: 17 requests: 18 storage: 256Mi 19--- 20apiVersion: apps/v1 21kind: Deployment 22metadata: 23 name: teamspeak-deployment 24 namespace: teamspeak 25 labels: 26 app: teamspeak 27spec: 28 replicas: 1 29 selector: 30 matchLabels: 31 app: teamspeak 32 template: 33 metadata: 34 namespace: teamspeak 35 labels: 36 app: teamspeak 37 spec: 38 containers: 39 - name: teamspeak-server 40 image: monadt/teamspeak3-server:3.11.0 41 ports: 42 - name: ts 43 containerPort: 9987 44 protocol: UDP 45 resources: 46 env: 47 - name: TS3SERVER_LICENSE 48 value: accept 49 volumeMounts: 50 - mountPath: /var/ts3server/ 51 name: teamspeak-data 52 volumes: 53 - name: teamspeak-data 54 persistentVolumeClaim: 55 claimName: teamspeak-pvc 56--- 57apiVersion: v1 58kind: Service 59metadata: 60 name: teamspeak-service 61 namespace: teamspeak 62 labels: 63 app: teamspeak 64spec: 65 type: ClusterIP 66 ports: 67 - port: 9987 68 targetPort: ts 69 protocol: UDP 70 name: ts 71 selector: 72 app: teamspeak 73--- 74apiVersion: v1 75kind: ConfigMap 76metadata: 77 name: udp-services 78 namespace: ingress-nginx 79data: 80 9987: \"teamspeak/teamspeak-service:9987\" Apply this using kubectl:\n1kubectl apply -f teamspeak.yaml The 9987 udp port will also need to be added to the ingress service. In the ports section of the service add the following snippet:\n1kubectl edit svc ingress-nginx -n ingress-nginx 1- name: teamspeak 2 port: 9987 3 protocol: UDP 4 targetPort: 9987 Forwarding traffic to the ingress The final step depends a lot on the setup you are deploying the cluster in.\nIf it is behind your local router, you have to check which port was bound to the 9987 udp port and forward this to one of your cluster-nodes:\n1kubectl describe svc ingress-nginx -n ingress-nginx 1Name: ingress-nginx 2Namespace: ingress-nginx 3Labels: app.kubernetes.io/name=ingress-nginx 4 app.kubernetes.io/part-of=ingress-nginx 5Annotations: Selector: app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/part-of=ingress-nginx 6Type: NodePort 7IP: 10.43.33.70 8Port: http 80/TCP 9TargetPort: 80/TCP 10NodePort: http 32224/TCP 11Endpoints: 12Port: https 443/TCP 13TargetPort: 443/TCP 14NodePort: https 31955/TCP 15Endpoints: 16Port: teamspeak 9987/UDP 17TargetPort: 9987/UDP 18NodePort: teamspeak 31222/UDP 19Endpoints: 20Session Affinity: None 21External Traffic Policy: Cluster 22Events: In this case the port that needs to be forwarded is the 31222 port (the NodePort for the 9987 UDP port).\nFor Ubuntu you will have to edit the file /boot/firmware/cmdline.txt and add the options cgroup_memory=1 cgroup_enable=memory at the end of the line for k3s (or containers in general) to work. ↩︎\nSee https://github.com/kubernetes/ingress-nginx/pull/3852 ↩︎\n",
  "wordCount" : "907",
  "inLanguage": "en",
  "datePublished": "2020-05-08T22:59:00+02:00",
  "dateModified": "2020-05-08T22:59:00+02:00",
  "author":{
    "@type": "Person",
    "name": "Florian Bergmann"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.niflheim.cc/posts/teamspeak-k8s-arm/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Personal blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.niflheim.cc/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.niflheim.cc/" accesskey="h" title="Personal blog (Alt + H)">Personal blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.niflheim.cc/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://blog.niflheim.cc/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Deploying Teamspeak on a Raspberry PI kubernetes cluster
    </h1>
    <div class="post-meta"><span title='2020-05-08 22:59:00 +0200 CEST'>May 8, 2020</span>&nbsp;·&nbsp;Florian Bergmann

</div>
  </header> 
  <div class="post-content"><p>While this post will end up with a running <a href="https://www.teamspeak.com/en/">Teamspeak</a> server, it is very hard
on the resources of the Raspberry Pi and might not be suitable for everyday
use.</p>
<p>To deploy a teamspeak server on raspberry pi a few things need to be done:</p>
<ul>
<li>(optional) Get a Kubernetes cluster up and running (this is not required, if
you just want to run the <code>docker</code> container directly).</li>
<li>Get Teamspeak to run on <code>ARM</code>.</li>
<li>Setup an ingress controller to make the Teamspeak server accessible from the
outside world (in this case this will be the <a href="https://kubernetes.github.io/ingress-nginx/">Nginx Ingress</a>).</li>
</ul>
<h2 id="setting-up-a-kubernetes-cluster">Setting up a kubernetes cluster<a hidden class="anchor" aria-hidden="true" href="#setting-up-a-kubernetes-cluster">#</a></h2>
<p>To setup a kubernetes cluster on Raspberry Pis <a href="https://k3s.io/">K3S</a> is very good approach, as
the cluster will be more lightweight that simply installing upstream
kubernetes.</p>
<p>As a base I recommend using <a href="https://blog.hypriot.com/">HypriotOS</a> or <a href="https://ubuntu.com/download/server/arm">Ubuntu Server</a><sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> as those allow
configuring the images using <a href="https://cloudinit.readthedocs.io/en/latest/">Cloud-Init</a>.</p>
<p>Make sure to follow the instructions to use the the <code>legacy</code> backend for
<code>iptables</code> if installing <code>kubernetes</code> v1.17 or lower: <a href="https://v1-17.docs.kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#ensure-iptables-tooling-does-not-use-the-nftables-backend">kubeadm instructions</a>.</p>
<p>When installing <code>k3s</code> to run <code>Teamspeak</code> <code>Traefik</code> should not be installed,
as only the 2.x version supports <code>UDP</code> ingresses - so instead <code>nginx-ingress</code>
will be installed later:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">curl -sfL https://get.k3s.io <span class="p">|</span> sh -s - --no-deploy<span class="o">=</span>traefik
</span></span></code></pre></div><h2 id="deploy-teamspeak">Deploy Teamspeak<a hidden class="anchor" aria-hidden="true" href="#deploy-teamspeak">#</a></h2>
<h3 id="build-an-arm-image-for-teamspeak">Build an ARM image for Teamspeak<a hidden class="anchor" aria-hidden="true" href="#build-an-arm-image-for-teamspeak">#</a></h3>
<p>Teamspeak does not provide a binary for <code>ARM</code>.</p>
<p>It is however possible to run it using <a href="https://www.qemu.org/">Qemu</a> - I have already prepared an
<code>ARM</code> image that will run the Teamspeak server through <code>qemu</code> that you can
find on my <a href="https://hub.docker.com/repository/docker/monadt/teamspeak3-server">Dockerhub</a> - or if you want to see the source checkout the
repository on <a href="https://github.com/bergmannf/teamspeak3-server-arm">Github</a>.</p>
<p>The image is using the same <code>entrypoint.sh</code> as the <a href="https://hub.docker.com/%5F/teamspeak">official image</a> - so if
you are already using that one you should be able to use it exactly the same
way (if not - feel free to open an issue).</p>
<h3 id="deploy-the-image">Deploy the image<a hidden class="anchor" aria-hidden="true" href="#deploy-the-image">#</a></h3>
<p>Now - if you do not want to use <code>kubernetes</code>, you can simply use the image
using <code>docker</code> and expose the required <code>Teamspeak</code> ports as you would with
<code>docker</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">docker run -p 9987:9987/udp -p 10011:10011 -p 30033:30033 -e <span class="nv">TS3SERVER_LICENSE</span><span class="o">=</span>accept monadt/teamspeak3-server
</span></span></code></pre></div><p>This way is a lot easier on the resources and will likely run more reliable
on a Raspberry PI with &lt; 2 GB of RAM.</p>
<h2 id="setup-nginx-ingress">Setup nginx-ingress<a hidden class="anchor" aria-hidden="true" href="#setup-nginx-ingress">#</a></h2>
<h3 id="get-nginx-ingress-to-run-on-arm">Get nginx-ingress to run on ARM<a hidden class="anchor" aria-hidden="true" href="#get-nginx-ingress-to-run-on-arm">#</a></h3>
<p>Setting up the <code>nginx-ingress</code> on a cluster running on <code>ARM</code> needs a few extra
steps when using the <a href="https://kubernetes.github.io/ingress-nginx/deploy/">official documentation</a>.</p>
<p>The images used in the <code>manifests</code> are not compatible with <code>armv7</code> (that is
used when running a cluster on a bunch of Raspberry Pis).</p>
<p>First the <code>mandatory.yaml</code> has to be updated to use the images for the <code>arm</code>
architecture<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml
</span></span><span class="line"><span class="ln">2</span><span class="cl">sed -i <span class="s1">&#39;s/nginx-ingress-controller:0/nginx-ingress-controller-arm:0/&#39;</span> mandatory.yaml
</span></span></code></pre></div><p>The resulting <code>mandatory.yaml</code> file can now be applied to the cluster:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubectl apply -f mandatory.yaml
</span></span></code></pre></div><p>In my local cluster I am using the <code>NodePort</code> approach, so the service for
that can be applied next:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml
</span></span></code></pre></div><h2 id="setup-a-teamspeak-deployment">Setup a Teamspeak deployment<a hidden class="anchor" aria-hidden="true" href="#setup-a-teamspeak-deployment">#</a></h2>
<p>With all pieces in place the <code>Teamspeak</code> container can now be deployed onto
the cluster:</p>
<p>Save the following <code>yaml</code> into a file (e.g. <code>teamspeak.yaml</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Namespace</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolumeClaim</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak-pvc</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">local-path</span><span class="w">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="w">    </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">256Mi</span><span class="w">
</span></span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak-deployment</span><span class="w">
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">38</span><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">39</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak-server</span><span class="w">
</span></span></span><span class="line"><span class="ln">40</span><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">monadt/teamspeak3-server:3.11.0</span><span class="w">
</span></span></span><span class="line"><span class="ln">41</span><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">42</span><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ts</span><span class="w">
</span></span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="w">              </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">9987</span><span class="w">
</span></span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="w">              </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span></span></span><span class="line"><span class="ln">45</span><span class="cl"><span class="w">          </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">46</span><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">47</span><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">TS3SERVER_LICENSE</span><span class="w">
</span></span></span><span class="line"><span class="ln">48</span><span class="cl"><span class="w">            </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l">accept</span><span class="w">
</span></span></span><span class="line"><span class="ln">49</span><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">50</span><span class="cl"><span class="w">          </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/var/ts3server/</span><span class="w">
</span></span></span><span class="line"><span class="ln">51</span><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak-data</span><span class="w">
</span></span></span><span class="line"><span class="ln">52</span><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">53</span><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak-data</span><span class="w">
</span></span></span><span class="line"><span class="ln">54</span><span class="cl"><span class="w">          </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">55</span><span class="cl"><span class="w">            </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak-pvc</span><span class="w">
</span></span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">57</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">58</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="ln">59</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">60</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak-service</span><span class="w">
</span></span></span><span class="line"><span class="ln">61</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">62</span><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">63</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">64</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">65</span><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="ln">66</span><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">67</span><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9987</span><span class="w">
</span></span></span><span class="line"><span class="ln">68</span><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l">ts</span><span class="w">
</span></span></span><span class="line"><span class="ln">69</span><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span></span></span><span class="line"><span class="ln">70</span><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ts</span><span class="w">
</span></span></span><span class="line"><span class="ln">71</span><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">72</span><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">73</span><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="ln">74</span><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="ln">75</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="ln">76</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">77</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">udp-services</span><span class="w">
</span></span></span><span class="line"><span class="ln">78</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-nginx</span><span class="w">
</span></span></span><span class="line"><span class="ln">79</span><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">80</span><span class="cl"><span class="w">  </span><span class="nt">9987</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;teamspeak/teamspeak-service:9987&#34;</span><span class="w">
</span></span></span></code></pre></div><p>Apply this using <code>kubectl</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubectl apply -f teamspeak.yaml
</span></span></code></pre></div><p>The 9987 <code>udp</code> port will also need to be added to the <code>ingress</code> service.
In the <code>ports</code> section of the service add the following snippet:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubectl edit svc ingress-nginx -n ingress-nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">teamspeak</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">9987</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">  </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">UDP</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9987</span><span class="w">
</span></span></span></code></pre></div><h2 id="forwarding-traffic-to-the-ingress">Forwarding traffic to the ingress<a hidden class="anchor" aria-hidden="true" href="#forwarding-traffic-to-the-ingress">#</a></h2>
<p>The final step depends a lot on the setup you are deploying the cluster in.</p>
<p>If it is behind your local router, you have to check which port was bound to
the 9987 <code>udp</code> port and forward this to one of your cluster-nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="ln">1</span><span class="cl">kubectl describe svc ingress-nginx -n ingress-nginx
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="ln"> 1</span><span class="cl">Name:                     ingress-nginx
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">Namespace:                ingress-nginx
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">Labels:                   app.kubernetes.io/name=ingress-nginx
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">                          app.kubernetes.io/part-of=ingress-nginx
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">Annotations:              Selector:  app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/part-of=ingress-nginx
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">Type:                     NodePort
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">IP:                       10.43.33.70
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Port:                     http  80/TCP
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">TargetPort:               80/TCP
</span></span><span class="line"><span class="ln">10</span><span class="cl">NodePort:                 http  32224/TCP
</span></span><span class="line"><span class="ln">11</span><span class="cl">Endpoints:
</span></span><span class="line"><span class="ln">12</span><span class="cl">Port:                     https  443/TCP
</span></span><span class="line"><span class="ln">13</span><span class="cl">TargetPort:               443/TCP
</span></span><span class="line"><span class="ln">14</span><span class="cl">NodePort:                 https  31955/TCP
</span></span><span class="line"><span class="ln">15</span><span class="cl">Endpoints:
</span></span><span class="line"><span class="ln">16</span><span class="cl">Port:                     teamspeak  9987/UDP
</span></span><span class="line"><span class="ln">17</span><span class="cl">TargetPort:               9987/UDP
</span></span><span class="line"><span class="ln">18</span><span class="cl">NodePort:                 teamspeak  31222/UDP
</span></span><span class="line"><span class="ln">19</span><span class="cl">Endpoints:
</span></span><span class="line"><span class="ln">20</span><span class="cl">Session Affinity:         None
</span></span><span class="line"><span class="ln">21</span><span class="cl">External Traffic Policy:  Cluster
</span></span><span class="line"><span class="ln">22</span><span class="cl">Events:                   &lt;none&gt;
</span></span></code></pre></div><p>In this case the port that needs to be forwarded is the <code>31222</code> port (the
<code>NodePort</code> for the 9987 <code>UDP</code> port).</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>For Ubuntu you will have to edit the file <code>/boot/firmware/cmdline.txt</code> and add the options <code>cgroup_memory=1 cgroup_enable=memory</code> at the end of the line for <code>k3s</code> (or <code>containers</code> in general) to work.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>See <a href="https://github.com/kubernetes/ingress-nginx/pull/3852">https://github.com/kubernetes/ingress-nginx/pull/3852</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.niflheim.cc/tags/kubernetes/">kubernetes</a></li>
      <li><a href="https://blog.niflheim.cc/tags/arm/">arm</a></li>
      <li><a href="https://blog.niflheim.cc/tags/raspberry/">raspberry</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://blog.niflheim.cc/">Personal blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
